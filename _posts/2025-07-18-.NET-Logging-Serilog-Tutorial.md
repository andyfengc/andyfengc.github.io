---
layout: post
title: NET Logging Serilog Tutorial
author: Andy Feng
---

# Introduction
.NET ç”Ÿæ€ä¸­æœ‰å¤šä¸ªæµè¡Œçš„å…è´¹æ—¥å¿—ç³»ç»Ÿã€‚ä¸‹é¢æ˜¯ä¸€ä»½å¸¸è§æ—¥å¿—åº“çš„å¯¹æ¯”è¡¨ï¼Œæ¶µç›–åŠŸèƒ½ã€æ€§èƒ½ã€æ˜“ç”¨æ€§ã€ç»´æŠ¤æ´»è·ƒåº¦ã€ç”Ÿæ€æ”¯æŒç­‰ç»´åº¦ï¼š
ä¸»æµ .NET æ—¥å¿—åº“å¯¹æ¯”è¡¨ï¼ˆå…è´¹å¼€æºï¼‰

|åç§°|ä¼˜ç‚¹|ç¼ºç‚¹|GitHub Stars / ç»´æŠ¤æƒ…å†µ|å¸‚åœºä½¿ç”¨æƒ…å†µ / æ¡ˆä¾‹|
|---|---|---|---|---|
|**Serilog**|- åŸºäºç»“æ„åŒ–æ—¥å¿—ï¼ˆStructured Loggingï¼‰- å¼ºå¤§çš„ Sink æ”¯æŒï¼ˆè¾“å‡ºç›®æ ‡ï¼‰- æ–‡æ¡£å…¨ã€ç”Ÿæ€å¥½- ä¸ ASP.NET Core æ— ç¼é›†æˆ|- é»˜è®¤é…ç½®ç•¥å¤æ‚- æ—¥å¿—æ ¼å¼è¾ƒä¸ºåºå¤§ï¼ˆå¯¹æ€§èƒ½ç•¥å½±å“ï¼‰|â­ï¸ 6.4k+æ´»è·ƒç»´æŠ¤ä¸­|å¾®è½¯å®˜æ–¹æ–‡æ¡£æ¨èï¼Œä¸»æµæ¡†æ¶æ”¯æŒ|
|**NLog**|- é…ç½®ç®€å•çµæ´»ï¼ˆæ”¯æŒ XML å’Œä»£ç ï¼‰- Sink æ”¯æŒä¸°å¯Œ- æ€§èƒ½å¥½|- ç»“æ„åŒ–æ—¥å¿—æ”¯æŒä¸å¦‚ Serilog- é…ç½®ç³»ç»Ÿç•¥æ˜¾è€æ—§|â­ï¸ 5.5k+æ´»è·ƒç»´æŠ¤ä¸­|å¤§é‡ä¼ ç»Ÿä¼ä¸šã€æ¡Œé¢ç³»ç»Ÿä½¿ç”¨|
|**log4net**|- å†å²æ‚ ä¹…ï¼ŒApache åŸºé‡‘ä¼šé¡¹ç›®- æˆç†Ÿç¨³å®š|- é¡¹ç›®è¿‡äºè€æ—§- å¾ˆå°‘æ›´æ–°- ä¸æ”¯æŒ .NET Core çš„æ–°ç‰¹æ€§|â­ï¸ 1.6k+åŸºæœ¬åœæ­¢ç»´æŠ¤|ä¼ ç»Ÿ .NET Framework é¡¹ç›®|
|**Microsoft.Extensions.Logging**|- å®˜æ–¹å†…ç½®æ”¯æŒ- ä¸ ASP.NET Core ç´§å¯†æ•´åˆ- å¯ä½œä¸ºæ—¥å¿—æŠ½è±¡å±‚|- éœ€è¦é…åˆç¬¬ä¸‰æ–¹ Sinkï¼ˆå¦‚ Serilogï¼‰ä½¿ç”¨æ‰å¼ºå¤§|.NET å®˜æ–¹åŒ…æŒç»­æ›´æ–°|ASP.NET Core é»˜è®¤æ—¥å¿—æ¡†æ¶|
|**ElmahCore**|- Web å¼‚å¸¸æ•è·å‹å¥½ï¼Œè‡ªåŠ¨é¡µé¢è®°å½•- æ”¯æŒ MVC / Core- é…ç½®ç®€å•|- æ›´é€‚åˆåš Web å¼‚å¸¸å®¡è®¡- éé€šç”¨æ—¥å¿—è®°å½•å™¨|â­ï¸ 0.5k+æ´»è·ƒç»´æŠ¤ä¸­|é€‚åˆåšè¡¥å……æ—¥å¿—æˆ–é”™è¯¯è¿½è¸ªç³»ç»Ÿ|
|**Seqï¼ˆé…åˆ Serilogï¼‰**|- å›¾å½¢åŒ–ç»“æ„åŒ–æ—¥å¿—å¹³å°ï¼ˆWeb UIï¼‰- Serilog æœ€ä½³æ‹æ¡£|- Web UI æœ‰å…è´¹ç‰ˆå’Œä»˜è´¹ç‰ˆ- æœ¬è´¨æ˜¯æ—¥å¿—å¹³å°ï¼Œä¸æ˜¯åº“|â­ï¸ 5.5k+ï¼ˆSeq å®˜æ–¹ï¼‰|DevOps å›¢é˜Ÿå¸¸ç”¨ï¼Œå¯æœ¬åœ°éƒ¨ç½²|
æ¨èé€‰æ‹©å»ºè®®

|åœºæ™¯|æ¨èæ—¥å¿—åº“|ç†ç”±|
|---|---|---|
|ä¸€èˆ¬ ASP.NET Core é¡¹ç›®|Serilog + å®˜æ–¹ Logging|Serilog å†™æ—¥å¿—ï¼Œå®˜æ–¹ Logging åšæŠ½è±¡å±‚ï¼Œé…ç½®çµæ´»ï¼ŒåŠŸèƒ½å¼º|
|æ¡Œé¢åº”ç”¨ï¼ˆWinForms/WPFï¼‰|NLog|ç®€å•é…ç½®ï¼Œè¾“å‡ºæ–‡ä»¶ã€Windows æ—¥å¿—éƒ½å¾ˆå¥½ç”¨|
|åªéœ€è¦ä¸€ä¸ªå¼‚å¸¸ç›‘æ§åå°|ElmahCore|å¼€ç®±å³ç”¨ï¼Œæ”¯æŒé¡µé¢æŸ¥çœ‹ï¼Œé€‚åˆ MVC é¡¹ç›®|
|è€é¡¹ç›®ï¼ŒåŸºäº .NET Framework 4.x|log4net|ç¨³å®šå…¼å®¹ï¼Œè™½ç„¶è€æ—§ä½†å¤Ÿç”¨|
|äº‘åŸç”Ÿ / DevOps / æ—¥å¿—å¹³å°æ•´åˆ|Serilog + Seq / Grafana|Serilog è¾“å‡ºç»“æ„åŒ–æ—¥å¿—ï¼Œé…åˆ UI å¹³å°æ–¹ä¾¿è°ƒè¯•å’Œè¿ç»´|
## æ¨èç»„åˆ
Microsoft.Extensions.Logging + Serilog

|ç»„æˆ|ä½œç”¨è¯´æ˜|
|---|---|
|**Microsoft.Extensions.Logging**|å¾®è½¯å®˜æ–¹çš„æ—¥å¿—æ¥å£ï¼ˆILogger<T>ï¼‰æŠ½è±¡ï¼Œä¸ç»‘å®šå…·ä½“å®ç°|
|**Serilog**|å®ç° ILogger æ¥å£ï¼Œæä¾›ç»“æ„åŒ–æ—¥å¿—ã€æ¨¡æ¿åŒ–è¾“å‡ºã€æ–‡ä»¶/æ•°æ®åº“/äº‘ Sink æ”¯æŒç­‰|
ç»„åˆç»“æ„å›¾
```
åº”ç”¨ä»£ç ï¼ˆä¾èµ– ILogger<T>ï¼‰
         â”‚
         â–¼
Microsoft.Extensions.Loggingï¼ˆæŠ½è±¡ï¼‰
         â”‚
         â–¼
       Serilogï¼ˆå®ç° + é…ç½®ï¼‰
         â”‚
         â””â”€â”€ Sinkï¼ˆæ–‡ä»¶ã€æ§åˆ¶å°ã€æ•°æ®åº“ã€Seqã€ELKã€ApplicationInsights...ï¼‰
```
æˆ–è€…
Microsoft.Extensions.Logging + NLog
## Serilog vs NLog å…¨é¢å¯¹æ¯”

| å¯¹æ¯”é¡¹               | Serilog                      | NLog                 |
| ----------------- | ---------------------------- | -------------------- |
| ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹           | **ç»“æ„åŒ–æ—¥å¿—**ï¼Œæ”¯æŒè¯­ä¹‰åŒ–æ—¥å¿—å­—æ®µ          | **çµæ´»é…ç½®**ï¼Œæ”¯æŒä¼ ç»Ÿ XML é…ç½® |
| ğŸ§± é…ç½®æ–¹å¼           | ä»£ç é…ç½®ä¸ºä¸»ï¼ˆä¹Ÿæ”¯æŒ JSONï¼‰             | XML é…ç½®ä¸ºä¸»ï¼ˆä¹Ÿæ”¯æŒä»£ç é…ç½®ï¼‰    |
| ğŸ¯ Sink æ”¯æŒ        | ä¸°å¯Œï¼ˆæ§åˆ¶å°ã€æ–‡ä»¶ã€Seqã€Elasticsearchï¼‰ | ä¸°å¯Œï¼ˆæ–‡ä»¶ã€æ•°æ®åº“ã€é‚®ä»¶ã€ç½‘ç»œç­‰ï¼‰    |
| ğŸ“¦ åŒ…å¤§å°            | ç›¸å¯¹å°ï¼Œä¾èµ–è¾ƒå°‘                     | ç¨å¤§ä¸€äº›ï¼Œå†…ç½®è¾ƒå¤šåŠŸèƒ½          |
| ğŸ“ˆ æ€§èƒ½             | é«˜æ€§èƒ½ï¼Œæ”¯æŒå¼‚æ­¥ Sink                | é«˜æ€§èƒ½ï¼Œå†™å…¥æ–‡ä»¶é€Ÿåº¦æå¿«         |
| ğŸ› ï¸ æ˜“ç”¨æ€§           | åˆå­¦è€…ç¨å¾®éœ€è¦ç†è§£ç»“æ„åŒ–æ¦‚å¿µ               | æ›´åä¼ ç»Ÿæ—¥å¿—æ ¼å¼ï¼Œç®€å•ä¸Šæ‰‹        |
| ğŸ§© ä¸ ASP.NET Core | å®Œç¾æ”¯æŒï¼ˆUseSerilogï¼‰             | ä¹Ÿæ”¯æŒï¼ˆAddNLogï¼‰ï¼Œä½†éœ€æ›´å¤šé…ç½®  |
| ğŸªµ è¾“å‡ºæ ¼å¼           | æ”¯æŒ JSON / Key-Value / è‡ªå®šä¹‰æ¨¡æ¿  | æ–‡æœ¬ä¸ºä¸»ï¼Œä¹Ÿæ”¯æŒ JSON        |
| ğŸ“‹ æ–‡æ¡£             | éå¸¸å®Œå–„ï¼Œæ ·ä¾‹ä¸°å¯Œ                    | ä¹Ÿå¾ˆå®Œå–„ï¼Œä½†åå‘è€æ´¾å†™æ³•         |
| ğŸ§ª å•å…ƒæµ‹è¯•å‹å¥½         | é«˜ï¼Œæ—¥å¿—å¯æ³¨å…¥ILoggeræ¥å£             | ä¸­ç­‰ï¼Œéœ€é¢å¤–é€‚é…æ¥å£æ³¨å…¥         |
| ğŸ”„ ç”Ÿæ€             | é…åˆ `Seq`ã€`Grafana Loki` ç­‰æ›´æ´»è·ƒ | é…åˆè€é¡¹ç›®è¿ç§»ï¼Œé€‚åˆæ¡Œé¢è€é¡¹ç›®      |
| ğŸ‘´ å†å²             | æ–°ä¸€ä»£æ—¥å¿—åº“ï¼ˆè‡ª 2013 èµ·ï¼‰             | ç»å…¸è€ç‰Œåº“ï¼ˆè‡ª 2009 èµ·ï¼‰      |
| ğŸ§‘â€ğŸ’» ç¤¾åŒºç»´æŠ¤        | éå¸¸æ´»è·ƒï¼ˆGitHub Star 6k+ï¼‰        | æ´»è·ƒï¼ˆStar 5.5k+ï¼‰       |

# Microsoft.Extensions.Logging
Microsoft.Extensions.Logging æ˜¯å¾®è½¯ä¸º .NET æä¾›çš„ä¸€ä¸ªæ—¥å¿—æŠ½è±¡æ¡†æ¶ï¼Œæ˜¯`.NET Core/5+`åŠ`ASP.NET Core`çš„é»˜è®¤æ—¥å¿—ç³»ç»Ÿã€‚
å®ƒå®šä¹‰äº†ä¸€ä¸ªç»Ÿä¸€çš„æ—¥å¿— APIï¼ˆæ¥å£ï¼‰ï¼Œè®©ä½ å¯ä»¥åœ¨ä¸ä¾èµ–å…·ä½“æ—¥å¿—åº“ï¼ˆå¦‚ Serilogã€NLogã€log4net ç­‰ï¼‰çš„æƒ…å†µä¸‹ä½¿ç”¨æ—¥å¿—åŠŸèƒ½ã€‚
## æ ¸å¿ƒç†å¿µï¼š**æ—¥å¿—æŠ½è±¡å±‚**

ä½ åœ¨ä»£ç ä¸­åªä¾èµ–ï¼š

```
ILogger<T>
```
è€ŒçœŸæ­£çš„æ—¥å¿—å®ç°ï¼ˆå†™æ–‡ä»¶ã€å†™æ§åˆ¶å°ã€å†™æ•°æ®åº“ï¼‰å¯ä»¥é€šè¿‡æ³¨å†Œä¸åŒçš„â€œProviderâ€æ¥æ›¿æ¢ã€‚**é¢å‘æ¥å£ç¼–ç¨‹ï¼Œä¾¿äºæ›¿æ¢/æµ‹è¯•/è·¨å¹³å°å¤ç”¨ã€‚**

## ä½¿ç”¨æ¨è
- **æ¨èç”¨é€”**ï¼šåšä¸ºæ—¥å¿—æ¥å£å±‚ï¼Œç»Ÿä¸€æ—¥å¿—è°ƒç”¨æ–¹å¼
    
- **æ¨èæ­é…**ï¼š    
    - æ§åˆ¶å°æµ‹è¯•é¡¹ç›®ï¼š`AddConsole()` å³å¯        
    - Web é¡¹ç›®æˆ–æ­£å¼ç”Ÿäº§ç¯å¢ƒï¼šé…åˆ `Serilog` ä½¿ç”¨        
    - äº‘åŸç”Ÿï¼šé…åˆ `Application Insights`ã€`ElasticSearch`ã€`Seq` Sink
## åŒ…ç»“æ„

|åŒ…å|è¯´æ˜|
|---|---|
|`Microsoft.Extensions.Logging.Abstractions`|æä¾› `ILogger` æ¥å£å’ŒåŸºç¡€ç»“æ„|
|`Microsoft.Extensions.Logging`|æä¾›ç®€å•çš„æ§åˆ¶å° Providerï¼ˆä¸ä¾èµ– ASP.NETï¼‰|
|`Microsoft.Extensions.Logging.Console`|æ§åˆ¶å°æ—¥å¿— Provider|
|`Microsoft.Extensions.Logging.Debug`|è¾“å‡ºåˆ° Visual Studio çš„è¾“å‡ºçª—å£|
|`Microsoft.Extensions.Logging.EventLog`|å†™å…¥ Windows EventLog|
|`Microsoft.Extensions.Logging.AzureAppServices`|Azure äº‘ç¯å¢ƒæ—¥å¿—è¾“å‡ºæ”¯æŒ|
|ç¬¬ä¸‰æ–¹ Providerï¼ˆå¦‚ Serilogã€NLogï¼‰|å®ç°äº† `ILoggerProvider` æ¥å£|
## æ ¸å¿ƒæ¥å£ä»‹ç»

| ç±»å‹                | è¯´æ˜                                                      |
| ----------------- | ------------------------------------------------------- |
| `ILogger<T>`      | æ³›å‹æ—¥å¿—æ¥å£ï¼ŒT ä¸ºä¸Šä¸‹æ–‡ï¼ˆå¦‚ç±»åï¼‰                                      |
| `ILogger`         | éæ³›å‹ç‰ˆæœ¬ï¼Œé€‚åˆå·¥å‚æ¨¡å¼åŠ¨æ€ä½¿ç”¨                                        |
| `ILoggerFactory`  | åˆ›å»ºæ—¥å¿—å¯¹è±¡ï¼Œæ·»åŠ  Provider                                      |
| `ILoggingBuilder` | ç”¨äºæ³¨å†Œå„ç§ Provider                                         |
| `ILoggerProvider` | æä¾›å…·ä½“æ—¥å¿—å®ç°ï¼ˆSerilogã€NLogï¼‰                                  |
| `LogLevel`        | æ—¥å¿—ç­‰çº§æšä¸¾ï¼ˆTrace, Debug, Info, Warn, Error, Critical, Noneï¼‰ |
## Console example
```csharp
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

var serviceProvider = new ServiceCollection()
    .AddLogging(builder =>
    {
        builder.AddConsole();
        builder.SetMinimumLevel(LogLevel.Information);
    })
    .BuildServiceProvider();

var logger = serviceProvider.GetRequiredService<ILogger<Program>>();
logger.LogInformation("Hello from Microsoft.Extensions.Logging!");
```
## æ—¥å¿—ç­‰çº§è¯´æ˜ï¼ˆ`LogLevel`ï¼‰

| ç­‰çº§            | å«ä¹‰                | æ˜¯å¦ç”Ÿäº§ç¯å¢ƒæ¨è |
| ------------- | ----------------- | -------- |
| `Trace`       | æœ€è¯¦ç»†çš„æ—¥å¿—ï¼Œè°ƒè¯•çº§è°ƒç”¨æ ˆ     | âŒ        |
| `Debug`       | è°ƒè¯•ä¿¡æ¯ï¼Œé€‚ç”¨äºå¼€å‘è°ƒè¯•      | âŒ        |
| `Information` | ä¸€èˆ¬æ€§ä¸šåŠ¡ä¿¡æ¯ï¼Œç³»ç»ŸçŠ¶æ€ã€æµç¨‹æ—¥å¿— | âœ…        |
| `Warning`     | æ½œåœ¨é”™è¯¯ã€å¼‚å¸¸ï¼Œä½†ä¸å½±å“ä¸šåŠ¡    | âœ…        |
| `Error`       | ä¸šåŠ¡å¤±è´¥ã€ç³»ç»Ÿå¼‚å¸¸ï¼ˆå¯æ¢å¤ï¼‰    | âœ…        |
| `Critical`    | ä¸¥é‡æ•…éšœã€ç³»ç»Ÿå´©æºƒå‰å…†       | âœ… å¼ºçƒˆå»ºè®®è®°å½• |
| `None`        | å…³é—­æ‰€æœ‰æ—¥å¿—è®°å½•          | ä¸€èˆ¬ä¸ä½¿ç”¨    |
## ä¸ ASP.NET Core çš„é›†æˆæ–¹å¼

ASP.NET Core è‡ªåŠ¨æ³¨å†Œäº† `ILogger<T>`ï¼Œä½ åªéœ€è¦æ„é€ å‡½æ•°æ³¨å…¥å³å¯ï¼š
```csharp
public class HomeController : Controller
{
    private readonly ILogger<HomeController> _logger;
    public HomeController(ILogger<HomeController> logger)
    {
        _logger = logger;
    }

    public IActionResult Index()
    {
        _logger.LogInformation("è®¿é—® Index é¡µé¢");
        return View();
    }
}
```
æ—¥å¿—è¾“å‡ºé€šè¿‡é…ç½®æ–‡ä»¶ `appsettings.json` æ§åˆ¶ï¼š
```json
"Logging": {
  "LogLevel": {
    "Default": "Information",
    "Microsoft": "Warning",
    "Microsoft.Hosting.Lifetime": "Information"
  }
}
```
## æ—¥å¿— Provider æ›¿æ¢æœºåˆ¶

ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•æ—¥å¿—ç³»ç»Ÿä½œä¸º Providerï¼Œåªè¦å®ç°äº† `ILoggerProvider` æ¥å£ï¼Œæ¯”å¦‚ï¼š

|ç¬¬ä¸‰æ–¹æ—¥å¿—åº“|ä½¿ç”¨æ–¹å¼|
|---|---|
|Serilog|`.UseSerilog()`|
|NLog|`.AddNLog()`ï¼ˆéœ€è¦ `Microsoft.Extensions.Logging.NLog`ï¼‰|
|log4net|`.AddLog4Net()`|
## ä¼˜ç¼ºç‚¹
ä¼˜ç‚¹æ€»ç»“

|ä¼˜ç‚¹|è¯´æ˜|
|---|---|
|æŠ½è±¡å±‚è®¾è®¡|è§£è€¦æ—¥å¿—é€»è¾‘ä¸æ—¥å¿—å®ç°ï¼Œä¾¿äºæ›¿æ¢å’Œå•å…ƒæµ‹è¯•|
|å†…ç½®å¤šç§ Provider|æ§åˆ¶å°ã€è°ƒè¯•çª—å£ã€EventLogã€Azure AppService ç­‰|
|é…ç½®çµæ´»|æ”¯æŒä»£ç é…ç½®å’Œ JSON é…ç½®|
|ä¸ ASP.NET Core æ·±åº¦é›†æˆ|è‡ªåŠ¨æ³¨å…¥ ILogger<T>ï¼Œæ”¯æŒä¸­é—´ä»¶ã€è¿‡æ»¤å™¨ç­‰|
|æ”¯æŒä½œç”¨åŸŸ|å¯è®°å½•è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œæ—¥å¿—ä¸­é™„å¸¦ TraceIdã€RequestId ç­‰ä¿¡æ¯|
å±€é™æ€§

|å±€é™ / ç‰¹ç‚¹|è¯´æ˜|
|---|---|
|ä¸ç›´æ¥æ”¯æŒç»“æ„åŒ–æ—¥å¿—è¾“å‡º|éœ€è¦ Serilog/NLog ç­‰ç¬¬ä¸‰æ–¹åº“è¡¥å……|
|è‡ªå¸¦ Provider åŠŸèƒ½è¾ƒç®€å•|æ§åˆ¶å°è¾“å‡ºæœ‰é™ï¼Œç¼ºå°‘å¼‚æ­¥å†™å…¥ã€æ—¥å¿—å‹ç¼©ç­‰åŠŸèƒ½|
|æ— å›¾å½¢åŒ–ç•Œé¢ / æŸ¥è¯¢åŠŸèƒ½|ä¸åŒ…å«æŸ¥çœ‹ç³»ç»Ÿï¼ˆéœ€é…åˆç¬¬ä¸‰æ–¹å¦‚ Seq/ELKï¼‰|

# Serilog  
Serilog æ˜¯ ä¸€æ¬¾ä¸“æ³¨äº**ç»“æ„åŒ–æ—¥å¿—è®°å½•**çš„.NETæ—¥å¿—åº“ï¼Œä»¥ç®€æ´ã€çµæ´»å’Œé«˜æ€§èƒ½è‘—ç§°ã€‚
    
**æ ¸å¿ƒæ€æƒ³**ï¼šå°†æ—¥å¿—è§†ä¸º**äº‹ä»¶æµ**ï¼ˆEvent Streamï¼‰ï¼Œæ¯æ¡æ—¥å¿—åŒ…å«**å±æ€§é›†**ï¼ˆé”®å€¼å¯¹ï¼‰ï¼Œè€Œéçº¯æ–‡æœ¬ã€‚

**å…³é”®åŒ…**ï¼š

- `Serilog`ï¼ˆæ ¸å¿ƒåº“ï¼‰	
- `Serilog.Sinks.Console`/`File`/`Elasticsearch`ç­‰ï¼ˆè¾“å‡ºç›®æ ‡ï¼‰	
- `Serilog.Enrichers`ï¼ˆä¸Šä¸‹æ–‡å¢å¼ºï¼‰

ASP.NET Core WebAPIé¡¹ç›®ï¼ŒåŸç”Ÿæ”¯æŒã€‚
WPF / WinForms	é¡¹ç›®ã€‚å¯å¤ç”¨ Serilog é…ç½®ï¼Œä½†éœ€è¦æ‰‹åŠ¨æ¥ç®¡ `ILogger` æ³¨å†Œã€‚
## æ ¸å¿ƒç»„ä»¶

|ç»„ä»¶|ä½œç”¨|
|---|---|
|**Logger**|è®°å½•æ—¥å¿—çš„ä¸»æ¥å£ï¼Œé€šè¿‡`Log.Logger`å…¨å±€è®¿é—®|
|**Sink**|æ—¥å¿—è¾“å‡ºç›®æ ‡ï¼ˆå¦‚æ–‡ä»¶ã€æ•°æ®åº“ã€äº‘æœåŠ¡ï¼‰|
|**Enricher**|ä¸ºæ—¥å¿—æ·»åŠ ä¸Šä¸‹æ–‡å±æ€§ï¼ˆå¦‚æœºå™¨åã€çº¿ç¨‹IDï¼‰|
|**Formatter**|æ§åˆ¶æ—¥å¿—æ ¼å¼ï¼ˆJSONã€çº¯æ–‡æœ¬ç­‰ï¼‰|
|**Filter**|åŠ¨æ€è¿‡æ»¤æ—¥å¿—äº‹ä»¶|
## **ä¸°å¯Œçš„Sinksç”Ÿæ€ç³»ç»Ÿ**
Sink æ˜¯ Serilog æ—¥å¿—ç³»ç»Ÿçš„Â **è¾“å‡ºç›®æ ‡**ï¼Œå†³å®šæ—¥å¿—äº‹ä»¶æœ€ç»ˆè¢«å†™å…¥åˆ°å“ªé‡Œã€‚

- **å®˜æ–¹/ç¤¾åŒºæ”¯æŒçš„Sinks**ï¼š
    
    - æ§åˆ¶å°/æ–‡ä»¶ï¼š`Console`,Â `File`,Â `RollingFile`        
    - æ•°æ®åº“ï¼š`SQLServer`,Â `PostgreSQL`,Â `MongoDB`        
    - äº‘æœåŠ¡ï¼š`AzureTableStorage`,Â `AWSCloudWatch        
    - æ—¥å¿—ç³»ç»Ÿï¼š`Elasticsearch`,Â `Seq`,Â `Graylog`        
    - æ¶ˆæ¯é˜Ÿåˆ—ï¼š`RabbitMQ`,Â `Kafka`

| Sink ç±»å‹             | åŒ…å                                  | ç¤ºä¾‹ç”¨é€”               |
| ------------------- | ----------------------------------- | ------------------ |
| æ§åˆ¶å°                 | `Serilog.Sinks.Console`             | Debugã€æ§åˆ¶å°å¼€å‘        |
| æ–‡ä»¶ï¼ˆæ»šåŠ¨ï¼‰              | `Serilog.Sinks.File`                | å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œæ”¯æŒæŒ‰å¤©æ»šåŠ¨      |
| Seq                 | `Serilog.Sinks.Seq`                 | é…åˆæ—¥å¿—æŸ¥çœ‹å¹³å°ï¼Œæ”¯æŒ Web UI |
| Elasticsearch       | `Serilog.Sinks.Elasticsearch`       | æ—¥å¿—å¯¹æ¥ ELK           |
| MSSQL / SQLite      | `Serilog.Sinks.MSSqlServer`         | å†™å…¥å…³ç³»å‹æ•°æ®åº“           |
| ApplicationInsights | `Serilog.Sinks.ApplicationInsights` | Azure äº‘å¹³å°          |
| Telegram            | `Serilog.Sinks.Telegram`            | é”™è¯¯æ¶ˆæ¯æ¨é€             |
### **è‡ªå®šä¹‰ Sink å¼€å‘**
```csharp
public class CustomSink : ILogEventSink
{
    public void Emit(LogEvent logEvent)
    {
        var message = logEvent.RenderMessage();
        MyStorageSystem.Save(message); // è‡ªå®šä¹‰å­˜å‚¨é€»è¾‘
    }
}

// æ³¨å†Œ
.WriteTo.Sink(new CustomSink())
```
åŒ…è£…ç°æœ‰sinkï¼Œè£…é¥°å™¨æ¨¡å¼
```csharp
public class BufferedSink : ILogEventSink
{
    private readonly ILogEventSink _innerSink;
    private readonly List<LogEvent> _buffer = new();

    public BufferedSink(ILogEventSink innerSink) => _innerSink = innerSink;

    public void Emit(LogEvent logEvent)
    {
        _buffer.Add(logEvent);
        if (_buffer.Count >= 10)
        {
            foreach (var evt in _buffer) _innerSink.Emit(evt);
            _buffer.Clear();
        }
    }
}
```
## **ä¸Šä¸‹æ–‡å¢å¼ºï¼ˆEnrichersï¼‰**
**å†…ç½®Enrichers**ï¼š
```csharp
.Enrich.WithMachineName()    // æ·»åŠ æœºå™¨å
.Enrich.WithThreadId()       // æ·»åŠ çº¿ç¨‹ID
.Enrich.WithCorrelationId()  // æ·»åŠ è¯·æ±‚å…³è”ID
```
**è‡ªå®šä¹‰å±æ€§**ï¼š
```csharp
using (LogContext.PushProperty("TransactionId", Guid.NewGuid()))
{
    Log.Information("Processing payment");
}
```
ä¾‹å­ï¼ŒEnricherè‡ªåŠ¨æ·»åŠ ä¸Šä¸‹æ–‡å­—æ®µ
```csharp
.WriteTo.Console()
.Enrich.WithProperty("Application", "MyWpfApp")
.Enrich.FromLogContext()
```
ä¼šåœ¨æ¯æ¡æ—¥å¿—ä¸­è‡ªåŠ¨æ·»åŠ ï¼š
```json
{ "Application": "MyWpfApp" }
```
## ä½¿ç”¨æ–¹å¼
å¯ä»¥ç”¨ DI æ³¨å…¥ `ILogger<T>`ï¼Œé…åˆ `Microsoft.Extensions.DependencyInjection`ã€‚
```csharp
public class MyService : IMyService
{
    private readonly ILogger<MyService> _logger;

    public MyService(ILogger<MyService> logger)
    {
        _logger = logger;
    }

    public void DoSomething()
    {
        _logger.Information("çª—ä½“å¯åŠ¨ï¼š{Time}", DateTime.Now);
		_logger.Error(ex, "å‘ç”Ÿé”™è¯¯ï¼š{Message}", ex.Message);
    }
}
```
ç›´æ¥ä½¿ç”¨é™æ€ç±»`Log`ã€‚
```csharp
Log.Information("çª—ä½“å¯åŠ¨ï¼š{Time}", DateTime.Now);
Log.Error(ex, "å‘ç”Ÿé”™è¯¯ï¼š{Message}", ex.Message);
```
## Tips
**å§‹ç»ˆä½¿ç”¨`LogContext`**ï¼šä¸ºè¯·æ±‚é“¾æ·»åŠ å…³è”IDã€‚
    
**é¿å…å­—ç¬¦ä¸²æ‹¼æ¥**ï¼šåˆ©ç”¨æ¶ˆæ¯æ¨¡æ¿ä¼ é€’å±æ€§ã€‚
    
**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```csharp
.WriteTo.Console(new JsonFormatter())
.WriteTo.Elasticsearch(new ElasticsearchSinkOptions(...))
.AuditTo.File("logs/audit.log") // å®¡è®¡æ—¥å¿—
```
å¼‚å¸¸è®°å½•
```csharp
try { ... }
catch (Exception ex) {
    Log.Error(ex, "Operation failed for {UserId}", userId);
}
```
## Serilog vs NLog vs log4net

|ç‰¹æ€§|Serilog|NLog|log4net|
|---|---|---|---|
|**ç»“æ„åŒ–æ—¥å¿—**|åŸç”Ÿæ”¯æŒ|éœ€æ‰‹åŠ¨é…ç½®|ä¸æ”¯æŒ|
|**æ€§èƒ½**|é«˜ï¼ˆå¼‚æ­¥ä¼˜åŒ–ï¼‰|æé«˜|ä¸­ç­‰|
|**é…ç½®æ–¹å¼**|ä»£ç /JSON|XML/ä»£ç |XML|
|**æ‰©å±•ç”Ÿæ€**|200+ Sinks|100+ Targets|è¾ƒå°‘|
|**ASP.NET Coreé›†æˆ**|å®˜æ–¹æ¨è|éœ€é€‚é…|ä¸æ¨è|
## æœ€å°å¯è¿è¡Œ Serilog æ—¥å¿—ä»£ç ä¾‹å­
é…ç½®ï¼š
```csharp
using Serilog;

Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Debug()
    .WriteTo.Console()
    .WriteTo.File("logs/log-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();
```
ä½¿ç”¨
```csharp
Log.Information("åº”ç”¨å¯åŠ¨æˆåŠŸäº {Time}", DateTime.Now);
Log.Error(new Exception("ç¤ºä¾‹å¼‚å¸¸"), "å‡ºé”™å•¦");
```
å…³é—­
```csharp
Log.CloseAndFlush();
```
## æ¨èä½¿ç”¨æ–¹å¼æ€»ç»“

| åœºæ™¯           | æ¨èä½¿ç”¨æ–¹å¼                                             |
| ------------ | -------------------------------------------------- |
| æ§åˆ¶å°/æ¡Œé¢é¡¹ç›®     | `.WriteTo.File(...)` + `.WriteTo.Console()`        |
| ASP.NET Core | `UseSerilog()` + JSON é…ç½®æˆ–ä»£ç é…ç½®                      |
| ç”Ÿäº§ç¯å¢ƒ         | `.MinimumLevel.Information()` + æ–‡ä»¶ / Seq / DB Sink |
| å¼‚å¸¸æ—¥å¿—         | `Log.Error(ex, "å‡ºé”™å•¦ï¼š{Message}", ex.Message)`       |
## æ³¨æ„äº‹é¡¹

|æ³¨æ„ç‚¹|å»ºè®®|
|---|---|
|å…³é—­æ—¥å¿—|ç¨‹åºé€€å‡ºå‰è°ƒç”¨ `Log.CloseAndFlush()`ï¼Œé¿å…æ—¥å¿—æœªå†™å®Œä¸¢å¤±|
|å¤šçº¿ç¨‹æ€§èƒ½|ä½¿ç”¨å¼‚æ­¥ Sinkï¼ˆå¦‚ Async Sink æˆ– DurableFile Sinkï¼‰|
|æ—¥å¿—æ ¼å¼è‡ƒè‚¿|åˆç†è®¾ç½®å­—æ®µæ•°é‡ï¼Œé¿å…åµŒå¥—æ·±çš„ç»“æ„æ€§æ•°æ®|
|æ—¥å¿—è¿‡å¤§|é…ç½®æ—¥å¿—æ¸…ç†ç­–ç•¥ï¼ˆå¦‚æ¯å¤©æ»šåŠ¨ã€ä¿ç•™ N å¤©ï¼‰|
# Webé¡¹ç›® (.NET Core)
å®‰è£…nuget
```csharp
dotnet add package Serilog.AspNetCore
dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.Sinks.File
```
 Program.cs é…ç½®
 ```csharp
 using Serilog;

var builder = WebApplication.CreateBuilder(args);

// è®¾ç½® Serilog
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File("logs/log-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();

// æ›¿æ¢é»˜è®¤ LoggerFactory
builder.Host.UseSerilog();
// or
builder.Host.UseSerilog((ctx, lc) =>
{
    lc.ReadFrom.Configuration(ctx.Configuration); // ä» appsettings.json è¯»å–é…ç½®
});
// or
builder.Host.UseSerilog((ctx, config) => 
{
    config.ReadFrom.Configuration(ctx.Configuration)
          .Enrich.FromLogContext()
          .WriteTo.Console(outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}");
});

builder.Services.AddControllers();
var app = builder.Build();

app.UseAuthorization();
app.MapControllers();
app.Run();
```
æ§åˆ¶å™¨æˆ–æœåŠ¡ä¸­ä½¿ç”¨ï¼š
```csharp
public class HomeController : Controller
{
    private readonly ILogger<HomeController> _logger;

    public HomeController(ILogger<HomeController> logger)
    {
        _logger = logger;
    }

    public IActionResult Index()
    {
        _logger.LogInformation("Index page visited at {Time}", DateTime.Now);
        return View();
    }
}
```
é«˜çº§é…ç½®ï¼ˆè¿‡æ»¤å™¨ã€æŒ‰ç±»åˆ«è®°å½•ï¼‰
```csharp
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Warning) // é™ä½ç³»ç»Ÿæ—¥å¿—çº§åˆ«
    .MinimumLevel.Override("YourApp.Services", LogEventLevel.Debug) // è‡ªå®šä¹‰å‘½åç©ºé—´çº§åˆ«
    .WriteTo.Console()
    .CreateLogger();
```
**é«˜çº§é…ç½®ï¼ˆJSONé…ç½®ï¼‰**
`appsettings.json`:
```json
{
  "Serilog": {
    "Using": ["Serilog.Sinks.Console"],
    "MinimumLevel": "Information",
    "WriteTo": [
      { "Name": "Console" },
      { 
        "Name": "File", 
        "Args": { "path": "logs/log.txt" }
      }
    ],
    "Enrich": ["FromLogContext", "WithMachineName"]
  }
}```

æ¨èæ—¥å¿—è¾“å‡ºç»“æ„ï¼ˆæ–‡ä»¶ï¼‰
```plaintext
/logs/
  log-20250719.txt
  log-20250720.txt
```
ä½¿ç”¨æ»šåŠ¨ç­–ç•¥ `RollingInterval.Day` è‡ªåŠ¨æ¯å¤©ç”Ÿæˆæ–°æ–‡ä»¶ã€‚
# Desktopé¡¹ç›®
## ğŸ“ é¡¹ç›®ç»“æ„é¢„è§ˆ
```bash
MyWpfApp/
â”œâ”€â”€ App.xaml
â”œâ”€â”€ App.xaml.cs
â”œâ”€â”€ MainWindow.xaml
â”œâ”€â”€ MainWindow.xaml.cs
â”œâ”€â”€ ViewModels/
â”‚   â””â”€â”€ MainViewModel.cs
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ ServiceRegistration.cs
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ log-*.txt
```

### å®‰è£… NuGet åŒ…
desktopé¡¹ç›®
```csharp
dotnet add package Serilog
dotnet add package Serilog.Extensions.Logging //è®© Serilog é€‚é…å¾®è½¯çš„ `ILogger`
dotnet add package Serilog.Sinks.File
dotnet add package Serilog.Sinks.Console
Serilog.Settings.Configuration
dotnet add package Microsoft.Extensions.DependencyInjection
dotnet add package Microsoft.Extensions.Logging
```
![](images/posts/Pasted%20image%2020250719035040.png)
![](images/posts/Pasted%20image%2020250719043911.png)
Serviceé¡¹ç›®
```

```
## é…ç½®å¹¶åˆå§‹åŒ–ï¼ˆåœ¨ App.xaml.cs æˆ– Program.csï¼‰
```csharp
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Serilog;
using System;
using System.Windows;
using MyWpfApp.ViewModels;

namespace MyWpfApp
{
    public partial class App : Application
    {
        public static IServiceProvider Services { get; private set; }

        protected override void OnStartup(StartupEventArgs e)
        {
            var serviceCollection = new ServiceCollection();

            // åˆå§‹åŒ– Serilog
            Log.Logger = new LoggerConfiguration()
                .MinimumLevel.Debug()
			    //.WriteTo.Console()
                .WriteTo.File("logs/log-.txt", rollingInterval: RollingInterval.Day)
                .CreateLogger();

            // æ³¨å†Œæ—¥å¿—
            serviceCollection.AddLogging(builder =>
            {
                builder.ClearProviders(); // æ¸…é™¤é»˜è®¤
                builder.AddSerilog();     // ä½¿ç”¨ Serilog
            });

            // æ³¨å†Œå…¶ä»–æœåŠ¡ï¼ˆViewModelã€æœåŠ¡ç­‰ï¼‰
            ServiceRegistration.ConfigureServices(serviceCollection);

            Services = serviceCollection.BuildServiceProvider();

            // å¯åŠ¨ä¸»çª—å£
            var mainWindow = new MainWindow
            {
                DataContext = Services.GetRequiredService<MainViewModel>()
            };
            mainWindow.Show();

            base.OnStartup(e);
        }
    }
}
```
ServiceRegistration.csï¼šæ³¨å†ŒæœåŠ¡å’Œ ViewModel
```csharp
using Microsoft.Extensions.DependencyInjection;
using MyWpfApp.ViewModels;

namespace MyWpfApp.Services
{
    public static class ServiceRegistration
    {
        public static void ConfigureServices(IServiceCollection services)
        {
            // æ³¨å†Œ ViewModel
            services.AddSingleton<MainViewModel>();
        }
    }
}

```
## è¿›é˜¶é…ç½®
æ·»åŠ config/logging.json
```json
{
    "Serilog": {
        "MinimumLevel": {
            "Default": "Information",
            "Override": {
                "Microsoft": "Warning",
                "System": "Warning"
            }
        },
        "Enrich": [ "FromLogContext" ],
        "WriteTo": [
            {
                "Name": "Console"
            },
            {
                "Name": "File",
                "Args": {
                    "path": "logs/log-.txt",
                    "rollingInterval": "Day",
                    "outputTemplate": "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj}{NewLine}{Exception}"
                }
            }
        ]
    }
}
```
LoggingConfiguration.csåŠ è½½å¹¶åˆå§‹åŒ–
```csharp
public static class LoggingConfiguration
{
	public static void ConfigureLogging(IServiceCollection services)
	{
		// 1. åŠ è½½ logging.json é…ç½®
		var loggingConfigPath = Path.Combine(AppContext.BaseDirectory, "config", "logging.json");
		if (!File.Exists(loggingConfigPath))
			throw new FileNotFoundException("æœªæ‰¾åˆ°æ—¥å¿—é…ç½®æ–‡ä»¶: logging.json");

		var configuration = new ConfigurationBuilder()
			.SetBasePath(AppContext.BaseDirectory)
			.AddJsonFile("config/logging.json", optional: false, reloadOnChange: true)
			.Build();

		// 2. åˆ›å»º Serilog å…¨å±€ logger
		Log.Logger = new LoggerConfiguration()
			.ReadFrom.Configuration(configuration)
			.CreateLogger();

		// 3. æ³¨å†Œ Microsoft.Extensions.Logging ä½¿ç”¨ Serilog
		services.AddLogging(loggingBuilder =>
		{
			loggingBuilder.ClearProviders(); // æ¸…é™¤é»˜è®¤æä¾›è€…
			loggingBuilder.AddSerilog();     // æ³¨å…¥ Serilog
		});

		// å¯é€‰ï¼šè°ƒè¯•è¾“å‡º
		Log.Information("Serilog æ—¥å¿—ç³»ç»Ÿå·²åˆå§‹åŒ–ã€‚");
	}
}
```
åœ¨ `ServiceConfiguration.cs` å¼€å¤´è°ƒç”¨æ³¨å†Œ
```csharp
public static void Configure(IServiceCollection services)
{
    // âœ… æ³¨å†Œæ—¥å¿—ç³»ç»Ÿï¼ˆæœ€æ—©æ‰§è¡Œï¼‰
    LoggingConfiguration.ConfigureLogging(services);

    // âœ… æ³¨å†Œé…ç½®ç³»ç»Ÿ
    AppConfigLoader.LoadAndRegisterAll(services);

    // å…¶ä»–æœåŠ¡æ³¨å†Œé€»è¾‘...
    ....
    services.AddSingleton<MainViewModel>();
	....
```
## `App.xaml.cs` é€€å‡ºå‰é‡Šæ”¾æ—¥å¿—èµ„æº
```csharp
protected override void OnExit(ExitEventArgs e)
{
    base.OnExit(e);
    
    // âœ… å¼ºåˆ¶åˆ·æ–°å¹¶å…³é—­ Serilog
    Serilog.Log.CloseAndFlush();
}
```
## ä½¿ç”¨logger

MainViewModel.csï¼šä½¿ç”¨` ILogger<T>`
```csharp
using Microsoft.Extensions.Logging;
using System;

namespace MyWpfApp.ViewModels
{
    public class MainViewModel
    {
        private readonly ILogger<MainViewModel> _logger;

        public MainViewModel(ILogger<MainViewModel> logger)
        {
            _logger = logger;
            _logger.LogInformation("MainViewModel åˆå§‹åŒ–äº {Time}", DateTime.Now);
        }

        public void DoSomething()
        {
            _logger.LogDebug("æ‰§è¡Œ DoSomething æ–¹æ³•...");
            try
            {
                // æ¨¡æ‹Ÿé”™è¯¯
                throw new Exception("æ¨¡æ‹Ÿå¼‚å¸¸");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å‘ç”Ÿå¼‚å¸¸ï¼š{Message}", ex.Message);
            }
        }
    }
}
```
 MainWindow.xaml.csï¼šè°ƒç”¨ ViewModel çš„æ—¥å¿—æ–¹æ³•
```csharp
using System.Windows;
using MyWpfApp.ViewModels;

namespace MyWpfApp
{
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();
        }

        private void Button_Click(object sender, RoutedEventArgs e)
        {
            if (DataContext is MainViewModel vm)
            {
                vm.DoSomething();
            }
        }
    }
}
```
MainWindow.xamlï¼šæ·»åŠ ä¸€ä¸ªæŒ‰é’®æµ‹è¯•æ—¥å¿—
```xml
<Window x:Class="MyWpfApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        Title="MainWindow" Height="200" Width="300">
    <Grid>
        <Button Content="æµ‹è¯•æ—¥å¿—" Click="Button_Click" Width="100" Height="30" VerticalAlignment="Center" HorizontalAlignment="Center"/>
    </Grid>
</Window>
```
æ—¥å¿—è¾“å‡ºï¼ˆlogs/log-20250719.txtï¼‰
```
[10:12:23 INF] MainViewModel åˆå§‹åŒ–äº 2025-07-19 10:12:23
[10:12:27 DBG] æ‰§è¡Œ DoSomething æ–¹æ³•...
[10:12:27 ERR] å‘ç”Ÿå¼‚å¸¸ï¼šæ¨¡æ‹Ÿå¼‚å¸¸
System.Exception: æ¨¡æ‹Ÿå¼‚å¸¸
   at MyWpfApp.ViewModels.MainViewModel.DoSomething() in ...
```

ä½¿ç”¨æ—¥å¿—æ³¨æ„ï¼šSerilog ä¸­Â `Log`Â æ˜¯é™æ€ç±»ï¼ˆé™¤éä½ ç”¨ä¾èµ–æ³¨å…¥ï¼‰ï¼Œåœ¨æ¡Œé¢ç¨‹åºé‡Œå¯ä»¥ç›´æ¥ç”¨ã€‚
```csharp
Log.Information("çª—ä½“å¯åŠ¨ï¼š{Time}", DateTime.Now);
Log.Error(ex, "å‘ç”Ÿé”™è¯¯ï¼š{Message}", ex.Message);
```
æ³¨æ„ï¼šSerilog ä¸­ `Log` æ˜¯é™æ€ç±»ï¼ˆé™¤éä½ ç”¨ä¾èµ–æ³¨å…¥ï¼‰ï¼Œåœ¨æ¡Œé¢ç¨‹åºé‡Œå¯ä»¥ç›´æ¥ç”¨ã€‚
# FAQ
## Log.CloseAndFlush() æ”¾åœ¨å“ªé‡Œï¼Ÿ
`Log.CloseAndFlush()` æ˜¯ **Serilog çš„é‡è¦æ¸…ç†æ–¹æ³•**ï¼Œç”¨äºåœ¨ç¨‹åºé€€å‡ºå‰**åˆ·æ–°ç¼“å†²åŒºå¹¶å®‰å…¨å…³é—­æ—¥å¿—èµ„æº**ï¼Œé˜²æ­¢æ—¥å¿—ä¸¢å¤±æˆ–æ–‡ä»¶æœªå…³é—­ã€‚

ä¸ºä»€ä¹ˆéœ€è¦è°ƒç”¨å®ƒï¼Ÿ
Serilog ä¸­æŸäº› Sinkï¼ˆå¦‚ `FileSink`, `AsyncSink`, `DurableSink`ï¼‰æ˜¯**ç¼“å†²å†™å…¥**ï¼Œå¦‚æœä¸è°ƒç”¨ `CloseAndFlush()`ï¼Œç¨‹åºå¼‚å¸¸é€€å‡ºæ—¶ï¼š

- æ—¥å¿—å¯èƒ½æœªå†™å…¥ç£ç›˜    
- æ–‡ä»¶å¥æŸ„æœªé‡Šæ”¾    
- æ§åˆ¶å°è¾“å‡ºå¯èƒ½ä¸å®Œæ•´

ä¸åŒé¡¹ç›®ç±»å‹ä¸­ `Log.CloseAndFlush()` çš„æ¨èä½ç½®ï¼š

| é¡¹ç›®ç±»å‹                      | æ¨èè°ƒç”¨ä½ç½®                         |
| ------------------------- | ------------------------------ |
| **æ§åˆ¶å°åº”ç”¨**                 | `Main` æ–¹æ³•æœ«å°¾ï¼Œ`try-finally` ä¸­    |
| **WPF / WinForms**        | `App.xaml.cs` ä¸­çš„ `OnExit()` æ–¹æ³• |
| **ASP.NET Core**          | `Program.cs` çš„ `try-finally` ä¸­ |
| **åå°æœåŠ¡ / Worker Service** | `Main` æ–¹æ³•æˆ– `IHost.Run()` å¤–éƒ¨    |
## ç¤ºä¾‹ï¼šæ§åˆ¶å°åº”ç”¨ä¸­ä½¿ç”¨
```csharp
class Program
{
    static void Main(string[] args)
    {
        Log.Logger = new LoggerConfiguration()
            .WriteTo.File("logs/log.txt")
            .CreateLogger();

        try
        {
            Log.Information("ç¨‹åºå¯åŠ¨");
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘...
        }
        catch (Exception ex)
        {
            Log.Fatal(ex, "ç¨‹åºå¼‚å¸¸é€€å‡º");
        }
        finally
        {
            Log.CloseAndFlush(); // å¿…é¡»æ”¾åœ¨æœ€å
        }
    }
}
```
## ç¤ºä¾‹ï¼šWPF é¡¹ç›®ä¸­ä½¿ç”¨
```csharp
public partial class App : Application
{
    protected override void OnStartup(StartupEventArgs e)
    {
        Log.Logger = new LoggerConfiguration()
            .WriteTo.File("logs/log.txt")
            .CreateLogger();

        Log.Information("WPF åº”ç”¨å¯åŠ¨");

        base.OnStartup(e);
    }

    protected override void OnExit(ExitEventArgs e)
    {
        Log.Information("WPF åº”ç”¨å…³é—­");
        Log.CloseAndFlush(); // æ”¾åœ¨è¿™é‡Œ
        base.OnExit(e);
    }
}
```
## .NET 5åŠæ—©æœŸç‰ˆæœ¬ç¤ºä¾‹(ä½¿ç”¨CreateHostBuilder)
```csharp
public static int Main(string[] args)
{
    Log.Logger = new LoggerConfiguration()
        .WriteTo.Console()
        .CreateLogger();

    try
    {
        Log.Information("å¯åŠ¨ WebHost");
        CreateHostBuilder(args).Build().Run();
        return 0;
    }
    catch (Exception ex)
    {
        Log.Fatal(ex, "Host å¯åŠ¨å¤±è´¥");
        return 1;
    }
    finally
    {
        Log.CloseAndFlush(); // âœ… æœ€åä¸€å®šè°ƒç”¨
    }
}

```
## .NET 6+(ä½¿ç”¨Program.cs)
```csharp
using Serilog;

Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Debug()
    .WriteTo.Console()
    .WriteTo.File("logs/web-log-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();

try
{
    Log.Information("åº”ç”¨å¯åŠ¨ä¸­...");

    var builder = WebApplication.CreateBuilder(args);

    // æ›¿æ¢é»˜è®¤ Logger
    builder.Host.UseSerilog();

    builder.Services.AddControllers();
    builder.Services.AddEndpointsApiExplorer();
    builder.Services.AddSwaggerGen();

    var app = builder.Build();

    // ä¸­é—´ä»¶æ³¨å†Œ
    if (app.Environment.IsDevelopment())
    {
        app.UseSwagger();
        app.UseSwaggerUI();
    }

    app.UseAuthorization();
    app.MapControllers();

    app.Run();

    Log.Information("åº”ç”¨æ­£å¸¸è¿è¡Œä¸­");
}
catch (Exception ex)
{
    Log.Fatal(ex, "åº”ç”¨å¯åŠ¨å¤±è´¥ï¼");
}
finally
{
    Log.CloseAndFlush(); // ğŸ”¥ å¿…é¡»ç¡®ä¿åœ¨æ‰€æœ‰æ—¥å¿—è°ƒç”¨åé‡Šæ”¾èµ„æº
}
```

è§£é‡Š

|éƒ¨åˆ†|è¯´æ˜|
|---|---|
|`Log.Logger = ...`|åˆå§‹åŒ– Serilog çš„å…¨å±€é™æ€å®ä¾‹|
|`builder.Host.UseSerilog()`|æ³¨å†Œ Serilog ä¸º .NET æ—¥å¿—ç³»ç»Ÿçš„å®ç°|
|`Log.CloseAndFlush()`|ç¡®ä¿æ‰€æœ‰æ—¥å¿—åˆ·æ–°å†™å…¥ç£ç›˜ã€èµ„æºé‡Šæ”¾ï¼Œé¿å…é—æ¼æœ€åçš„æ—¥å¿—|
|`try-catch-finally` åŒ…è£¹æ•´ä¸ªç¨‹åºå¯åŠ¨æµç¨‹|æ¨èåšæ³•ï¼Œå¯æ•æ‰å…¨å±€åˆå§‹åŒ–å¼‚å¸¸å¹¶è®°å½•|
è¯´æ˜
ASP.NET Core é¡¹ç›®ä¸­ Log.CloseAndFlush æœ€ä½³å®è·µ

|æ“ä½œ|æ¨èåšæ³•|
|---|---|
|åˆå§‹åŒ– `Log.Logger`|åœ¨ `Program.cs` çš„æœ€å‰é¢|
|æ³¨å†Œ `UseSerilog()`|æ›¿æ¢å†…ç½® ILoggerFactory|
|åŒ…è£¹ `builder.Build().Run()`|ä½¿ç”¨ `try-catch-finally`|
|finally ä¸­è°ƒç”¨ `CloseAndFlush`|ç¡®ä¿æ‰€æœ‰æ—¥å¿—å†™å…¥ã€æ–‡ä»¶å…³é—­ã€èµ„æºé‡Šæ”¾|
## â— å¦‚æœä¸è°ƒç”¨ä¼šæ€æ ·ï¼Ÿ

- ç¨‹åºæœ€åå‡ è¡Œæ—¥å¿—å¯èƒ½**å†™ä¸è¿›å»**    
- æ–‡ä»¶å¥æŸ„å¯èƒ½**æœªé‡Šæ”¾**    
- æŸäº›å¼‚æ­¥ Sinkï¼ˆå¦‚ ApplicationInsightsï¼‰å¯èƒ½**æ•°æ®ä¸¢å¤±**

âœ… æ€»ç»“

|æ“ä½œ|æ˜¯å¦å¿…é¡»|æ¨èåšæ³•|
|---|---|---|
|`Log.CloseAndFlush()`|âœ… æ˜¯|ç¨‹åºç»“æŸå‰ **å¿…é¡»è°ƒç”¨ä¸€æ¬¡**|
|æ”¾ç½®ä½ç½®|âœ… æ˜¯|`try-finally` æˆ– `OnExit` æ–¹æ³•|
# Reference
